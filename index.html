<html>
    <head> 
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
        <title>Workout Website</title>
        <link rel="stylesheet" href="style.css">
        <!-- Firebase SDKs -->
        <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
        <script src="scripts/firebase-init.js"></script>
        <script>
    
</script>
    </head>
    <body>
        <button id="sidebarToggle" style="display:none;position:fixed;top:10px;left:10px;z-index:10000;background:#2a5ad7;color:#fff;border:none;border-radius:6px;padding:8px 14px;font-size:18px;">☰</button>
        <button id="customSidebarToggle" style="display:none;position:fixed;top:10px;right:10px;z-index:10000;background:#2a5ad7;color:#fff;border:none;border-radius:6px;padding:8px 14px;font-size:18px;">★</button>
        <div id="workoutSidebar" style="position:fixed;left:0;top:0;bottom:0;width:260px;background:#f7f7f7;border-right:1px solid #ddd;overflow-y:auto;padding:16px;z-index:10;">
            <h2 style="margin-top:0;">Workout List</h2>
            <select id="sidebarYearSelect" style="width:100%;margin-bottom:10px;"></select>
            <div id="sidebarYearContent"></div>
        </div>
        <div id="customExercisesSidebar" style="position:fixed;right:0;top:0;bottom:0;width:260px;background:#f7f7f7;border-left:1px solid #ddd;overflow-y:auto;padding:16px;z-index:10;">
            <h3 style="margin-top:0;">Custom Exercises</h3>
            <button id="addCustomExerciseBtn" style="margin-bottom:12px;">➕ Add Custom Exercise</button>
            <ul id="customExercisesList" style="padding-left:18px;"></ul>
        </div>
        <div style="margin-left:270px; margin-right:270px; text-align: center">
            <h1>Workout Creator</h1>
            <div class="calendar">
                <h2> Workout Calendar </h2>
                <div>
                    <button id="prevMonth">&lt;</button>
                    <span id="monthYear"></span>
                    <button id="nextMonth">&gt;</button>
                </div>
                <ul class="weeks">
                    <li>Mon</li>
                    <li>Tue</li>
                    <li>Wed</li>
                    <li>Thu</li>
                    <li>Fri</li>
                    <li>Sat</li>
                    <li>Sun</li>
                </ul>
                <ul class="days" id="days"></ul>
            </div>
            <div class="add-workout-section">
                <h2>Add Workout</h2>
                                
            </div>
            <div id="workoutAccordion"></div>
            <div id="workoutModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
                <div style="background:#fff; padding:20px; border-radius:8px; min-width:250px; max-width:90vw;">
                    <h3>Workout Title</h3>
                    <input id="workoutTitleInput" type="text" placeholder="Workout Title" style="width:60%;margin-bottom:10px;">
                    <h3>Add Exercise</h3>
                    <div class="exercise-inputs" style="display:flex;flex-direction:column;align-items:flex-start;gap:10px;">
                        <label style="display:flex;flex-direction:row;align-items:center;gap:10px;">
                            <span style="min-width:90px;text-align:right;">Exercise:</span>
                            <select id="exerciseSelect"></select>
                        </label>
                        <label style="display:flex;flex-direction:row;align-items:center;gap:10px;">
                            <span style="min-width:90px;text-align:right;">Sets:</span>
                            <input type="number" id="setsInput" min="1" value="3" style="width:80px;">
                        </label>
                        <label id="repsLabel" style="display:flex;flex-direction:row;align-items:center;gap:10px;">
                            <span style="min-width:90px;text-align:right;">Reps:</span>
                            <input type="number" id="repsInput" min="1" value="10" style="width:80px;">
                        </label>
                        <label id="timeLabel" style="display:none;flex-direction:row;align-items:center;gap:10px;">
                            <span style="min-width:90px;text-align:right;">Time (sec):</span>
                            <input type="number" id="timeInput" min="1" value="30" style="width:80px;">
                        </label>
                        <label class="switch-label" style="display:flex;flex-direction:row;align-items:center;gap:10px;">
                            <span style="min-width:90px;text-align:right;">Use Time</span>
                            <input type="checkbox" id="isTimeInput" class="switch">
                            <span class="slider"></span>
                            <span style="font-size:13px;">Instead of Reps</span>
                        </label>
                        <label style="display:flex;flex-direction:row;align-items:center;gap:10px;"> 
                            <span style="min-width:90px;text-align:right;">Weight:</span>
                            <input type="number" id="weightInput" min="0" value="0" style="width:80px;">
                            <select id="weightUnitSelect">
                                <option value="lb">lb</option>
                                <option value="kg">kg</option>
                            </select>
                        </label>
                        <label style="display:flex;flex-direction:row;align-items:center;gap:10px;">
                            <span style="min-width:90px;text-align:right;">Rest (sec):</span>
                            <input type="number" id="restInput" min="0" value="60" style="width:80px;">
                        </label>
                    </div>
                    <button id="addExerciseBtn" type="button" style="margin-bottom:8px;">Add to Workout</button>
                    <ul id="exerciseList"></ul>
                    <label style="margin-top:10px;display:block;">
                        Select days to copy to (Ctrl+Click for multiple):
                        <input type="text" id="createCopyDaysInput" placeholder="YYYY-MM-DD,YYYY-MM-DD,..." style="margin-top:10px;width:90%;" readonly>
                    </label>
                    <button id="createSelectDaysBtn" style="margin-top:10px;">Select Days</button>
                    <div id="createDaysPopup" style="display:none;position:absolute;z-index:3000;background:#fff;border:1px solid #ccc;padding:10px;border-radius:8px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;">
                            <button id="createPrevMonthBtn">&lt;</button>
                            <span id="createPopupMonthYear"></span>
                            <button id="createNextMonthBtn">&gt;</button>
                        </div>
                        <div id="createPopupCalendar"></div>
                        <button id="createConfirmDaysBtn" style="margin-top:10px;">Confirm</button>
                        <button id="createCancelDaysBtn" style="margin-top:10px;">Cancel</button>
                    </div>
                    <button id="saveWorkoutBtn">Save</button>
                    <button id="cancelWorkoutBtn">Cancel</button>
                </div>
            </div>
            <div id="viewWorkoutModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
                <div style="background:#fff; padding:20px; border-radius:8px; min-width:250px; max-width:90vw;">
                    <h3 id="viewWorkoutTitle"></h3>
                    <ul id="viewWorkoutExercises"></ul>
                    <button id="closeViewWorkoutBtn">Close</button>
                    <button id="copyToDaysBtn" style="margin-left:10px;">Copy to Days</button>
                    <button id="deleteWorkoutBtn" style="margin-left:10px;color:#fff;background:#d9534f;">Delete Workout</button>
                    <br>
                    <label style="margin-top:10px;display:block;">
                        Select days to copy to (Ctrl+Click for multiple):
                        <input type="text" id="copyDaysInput" placeholder="YYYY-MM-DD,YYYY-MM-DD,..." style="margin-top:10px;width:90%;" readonly>
                    </label>
                    <button id="selectDaysBtn" style="margin-top:10px;">Select Days</button>
                    <div id="daysPopup" style="display:none;position:absolute;z-index:3000;background:#fff;border:1px solid #ccc;padding:10px;border-radius:8px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;">
                            <button id="copyPrevMonthBtn">&lt;</button>
                            <span id="copyPopupMonthYear"></span>
                            <button id="copyNextMonthBtn">&gt;</button>
                        </div>
                        <div id="popupCalendar"></div>
                        <button id="confirmDaysBtn" style="margin-top:10px;">Confirm</button>
                        <button id="cancelDaysBtn" style="margin-top:10px;">Cancel</button>
                    </div>
                </div>
            </div>


            <!-- Centered container for the share/import box -->
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:350px; margin-top:40px;">
                <div id="shareSidebar" style="box-shadow:0 2px 8px rgba(0,0,0,0.07); background:#fff; border-radius:10px; padding:20px 18px; min-width:260px;">
                    <h3>Share/Import Workouts</h3>
                    <button id="saveSharedBtn" style="margin-bottom:8px">Save a Workout</button>
                    <br>
                    <input type="text" id="shareCodeInput" placeholder="Enter keyword for importing" style="margin-bottom:8px;">
                    <button id="loadSharedBtn">Load Shared</button>
                    <div id="sharedWorkoutsList"
                        style="width:220px; height:180px; overflow-y:auto; border:1px solid #ccc; border-radius:6px; background:#fafafa; padding:8px; margin-top:8px; margin-bottom:32px;">
                    </div>
                </div>
            </div>

            
        </div>
        <!-- Exercise info tab -->
        <div id="exerciseInfoModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center;">
            <div style="background:#fff; padding:20px; border-radius:8px; min-width:250px; max-width:90vw;">
                <h3 id="exerciseInfoTitle"></h3>
                <img id="exerciseInfoImage" src="" alt="" style="max-width:200px;max-height:200px;display:block;margin-bottom:10px;">
                <p id="exerciseInfoDesc"></p>
                <button id="closeExerciseInfoBtn">Close</button>
            </div>
        </div>
        <button id="print-button">Print</button>

        <script> // JavaScript code

              let exerciseDatabase = [];

              document.addEventListener('DOMContentLoaded', function() {
                db.collection('exercises').get().then(snapshot => {
                  // Get exercises from Firestore
                  const firestoreExercises = snapshot.docs.map(doc => doc.data());
                  window.firestoreExercises = firestoreExercises;
                  // Get custom exercises from localStorage
                  const customExercises = JSON.parse(localStorage.getItem('customExercises')) || [];
                  // Merge and remove duplicates by name
                  exerciseDatabase = [
                    ...firestoreExercises,
                    ...customExercises.filter(
                      ce => !firestoreExercises.some(fe => fe.name === ce.name)
                    )
                  ];
                  populateExerciseSelect();
                  renderCustomExercisesList();
                });
                function populateExerciseSelect() {
                    const select = document.getElementById('exerciseSelect');
                    select.innerHTML = '';
                    exerciseDatabase.forEach(ex => {
                    const option = document.createElement('option');
                    option.value = ex.name;
                    option.textContent = ex.name;
                    select.appendChild(option);
                    });
                    }
                
                    // Initialize elements
                    let openAccordionSections = [];
                    const daysContainer = document.getElementById('days');
                    const monthYear = document.getElementById('monthYear');
                    const prevMonth = document.getElementById('prevMonth');
                    const nextMonth = document.getElementById('nextMonth');
                    let goBackBtn = document.querySelector('#back-button');

                    let date = new Date();

                    // Load workouts from localStorage or initialize
                    let workouts = JSON.parse(localStorage.getItem('workouts')) || {};

                    //Exercise Database
                    const savedCustomExercises = JSON.parse(localStorage.getItem('customExercises')) || [];
                    

                    // Modal elements
                    const workoutModal = document.getElementById('workoutModal');
                    const workoutTitleInput = document.getElementById('workoutTitleInput');
                    const exerciseSelect = document.getElementById('exerciseSelect');
                    const setsInput = document.getElementById('setsInput');
                    const repsInput = document.getElementById('repsInput');
                    const repsLabel = document.getElementById('repsLabel');
                    const addExerciseBtn = document.getElementById('addExerciseBtn');
                    const exerciseList = document.getElementById('exerciseList');
                    const saveWorkoutBtn = document.getElementById('saveWorkoutBtn');
                    const cancelWorkoutBtn = document.getElementById('cancelWorkoutBtn');
                    
                    // Sidebar elements
                    const weightInput = document.getElementById('weightInput');
                    const restInput = document.getElementById('restInput');
                    const isTimeInput = document.getElementById('isTimeInput');
                    const timeInput = document.getElementById('timeInput');
                    const timeLabel = document.getElementById('timeLabel');
                    const weightUnitSelect = document.getElementById('weightUnitSelect');
                    let weightUnit = localStorage.getItem('weightUnit') || 'lb';
                    weightUnitSelect.value = weightUnit;

                    weightUnitSelect.onchange = function() {
                        weightUnit = weightUnitSelect.value;
                        localStorage.setItem('weightUnit', weightUnit);
                    };

                    // Calendar elements
                    const viewWorkoutModal = document.getElementById('viewWorkoutModal');
                    const viewWorkoutTitle = document.getElementById('viewWorkoutTitle');
                    const viewWorksoutExercises = document.getElementById('viewWorkoutExercises');
                    const closeViewWorkoutBtn = document.getElementById('closeViewWorkoutBtn');
                    const deleteWorkoutBtn = document.getElementById('deleteWorkoutBtn');
                    const copyToDaysBtn = document.getElementById('copyToDaysBtn');
                    const copyDaysInput = document.getElementById('copyDaysInput');
                    const selectDaysBtn = document.getElementById('selectDaysBtn');
                    const daysPopup = document.getElementById('daysPopup');
                    const popupCalendar = document.getElementById('popupCalendar');
                    const confirmDaysBtn = document.getElementById('confirmDaysBtn');
                    const cancelDaysBtn = document.getElementById('cancelDaysBtn');
                    let viewWorkoutKey = null;

                    let currentWorkoutKey = null;
                    let currentExercises = [];
                    let currentTitle = "";

                    let selectedPopupDays = [];

                    // Populate exercise dropdown
                    function populateExerciseSelect() {
                        const select = document.getElementById('exerciseSelect');
                        select.innerHTML = '';
                        exerciseDatabase.forEach(ex => {
                            const opt = document.createElement('option');
                            opt.value = ex.name;
                            opt.textContent = ex.name;
                            select.appendChild(opt);
                        });
                        // Add "Add New Exercise..." at the end
                        const addNewOpt = document.createElement('option');
                        addNewOpt.value = '__add_new__';
                        addNewOpt.textContent = '➕ Add New Exercise...';
                        select.appendChild(addNewOpt);
                    }

                    // Populate exercise select with custom exercises
                    document.getElementById('exerciseSelect').onchange = function() {
                        if (this.value === '__add_new__') {
                            const newName = prompt('Enter new exercise name:');
                            if (newName && !exerciseDatabase.some(e => e.name === newName)) {
                                const description = prompt('Enter a description for this exercise (optional):') || "";
                                const image = prompt('Enter an image URL for this exercise (optional):') || "";
                                const newExercise = { name: newName, description, image };
                                exerciseDatabase.push(newExercise);
                                localStorage.setItem('customExercises', JSON.stringify(exerciseDatabase.filter(e => !["Push Up","Squat","Pull Up","Bench Press","Deadlift","Plank"].includes(e.name))));
                                populateExerciseSelect();
                                renderCustomExercisesList();
                                this.value = newName;
                            } else {
                                this.value = exerciseDatabase[0]?.name || '';
                            }
                        }
                    };

                    populateExerciseSelect();
                    renderCustomExercisesList();
                    exerciseSelect.value = "Push Up";
                    
                    // Populate custom exercises list
                    function renderCustomExercisesList() {
                        const list = document.getElementById('customExercisesList');
                        list.innerHTML = '';
                        if (exerciseDatabase.length === 0) {
                            list.innerHTML = '<li style="color:#888;">None</li>';
                            return;
                        }
                        // Get Firestore exercise names as defaultNames
                        const defaultNames = (window.firestoreExercises || []).map(e => e.name);

                        exerciseDatabase.forEach(ex => {
                            const li = document.createElement('li');
                            li.textContent = ex.name;
                            // View button
                            const viewBtn = document.createElement('button');
                            viewBtn.textContent = "View";
                            viewBtn.style.marginLeft = "8px";
                            viewBtn.style.fontSize = "12px";
                            viewBtn.onclick = function() {
                                document.getElementById('exerciseInfoTitle').textContent = ex.name;
                                document.getElementById('exerciseInfoDesc').textContent = ex.description || "No description.";
                                document.getElementById('exerciseInfoImage').src = ex.image || "";
                                document.getElementById('exerciseInfoImage').style.display = ex.image ? "block" : "none";
                                document.getElementById('exerciseInfoModal').style.display = 'flex';
                            };
                            li.appendChild(viewBtn);

                            // Only allow delete for custom exercises (not in Firestore)
                            if (!defaultNames.includes(ex.name)) {
                                const delBtn = document.createElement('button');
                                delBtn.textContent = "Delete";
                                delBtn.style.marginLeft = "8px";
                                delBtn.style.fontSize = "12px";
                                delBtn.onclick = function() {
                                    const idx = exerciseDatabase.findIndex(e => e.name === ex.name);
                                    if (idx !== -1) exerciseDatabase.splice(idx, 1);
                                    localStorage.setItem(
                                        'customExercises',
                                        JSON.stringify(exerciseDatabase.filter(e => !defaultNames.includes(e.name)))
                                    );
                                    populateExerciseSelect();
                                    renderCustomExercisesList();
                                };
                                li.appendChild(delBtn);
                            }
                            list.appendChild(li);
                        });
                    }

                    // Show modal
                    let initialCreateDayKey = null;

function showWorkoutModal(key) {
    currentWorkoutKey = key;
    initialCreateDayKey = key; 
    setsInput.value = 3;
    repsInput.value = 10;
    weightInput.value = 0;
    restInput.value = 60;
    isTimeInput.checked = false;
    timeLabel.style.display = 'none';
    timeInput.value = 30;
    exerciseSelect.selectedIndex = 0;
    workoutModal.style.display = 'flex';
    // Load existing workout if present
    if (workouts[key]) {
        let data = workouts[key];
        workoutTitleInput.value = data.title || "";
        currentExercises = data.exercises ? [...data.exercises] : [];
    } else {
        workoutTitleInput.value = "";
        currentExercises = [];
    }
    renderExerciseList();

    // Pre-fill the copy days input with the initial day
    createCopyDaysInput.value = key;
    selectedCreatePopupDays = [key];
}

                    // Hide modal
                    function hideWorkoutModal() {
                        workoutModal.style.display = 'none';
                        currentWorkoutKey = null;
                        currentExercises = [];
                        workoutTitleInput.value = "";
                        renderExerciseList();
                    }

                    // Add exercise to list
                    addExerciseBtn.onclick = function() {
                        const exercise = exerciseSelect.value;
                        const sets = setsInput.value;
                        const reps = repsInput.value;
                        const weight = weightInput.value;
                        const rest = restInput.value;
                        const isTime = isTimeInput.checked;
                        const time = timeInput.value;

                        // Validate inputs and add to list
                        if (exercise && sets > 0 && ((isTime && time > 0) || (!isTime && reps > 0))) {
                            currentExercises.push({
                                exercise,
                                sets,
                                reps: isTime ? null : reps,
                                time: isTime ? time : null,
                                weight,
                                rest,
                                isTime,
                                weightUnit
                            });
                            renderExerciseList();
                        }
                    };


                    // Render exercise list in modal
                    function renderExerciseList() {
                        exerciseList.innerHTML = "";
                        currentExercises.forEach((ex, idx) => {
                            let desc = `${ex.exercise} - ${ex.sets} sets x `;
                            desc += ex.isTime ? `${ex.time} sec` : `${ex.reps} reps`;
                            desc += ex.weight && ex.weight > 0 ? ` @ ${ex.weight}${ex.weightUnit || 'lb'}` : '';
                            if (ex.rest && ex.rest > 0) desc += `, Rest: ${ex.rest}s`;
                            const li = document.createElement('li');
                            li.textContent = desc;
                            // Remove button
                            const removeBtn = document.createElement('button');
                            removeBtn.textContent = "Remove";
                            removeBtn.style.marginLeft = "10px";
                            removeBtn.onclick = () => {
                                currentExercises.splice(idx, 1);
                                renderExerciseList();
                            };
                            li.appendChild(removeBtn);
                            exerciseList.appendChild(li);
                        });
                    }

                    // Save workout
                    saveWorkoutBtn.onclick = function() {
                        const title = workoutTitleInput.value.trim();
                        if (currentExercises.length === 0) {
                            alert("Add at least one exercise.");
                            return;
                        }
                        if (!title) {
                            alert("Please enter a workout title.");
                            return;
                        }
                        if (currentWorkoutKey) {
                            // Save the workout to the current key
                            workouts[currentWorkoutKey] = {
                                title,
                                exercises: currentExercises.map(ex => ({
                                    ...ex,
                                    weightUnit: weightUnit
                                }))
                            };
                            // Copy to selected days if any
                            let daysArr = createCopyDaysInput.value.trim().split(',').map(s => s.trim()).filter(Boolean);
                            // Always include the initial day
                            if (!daysArr.includes(initialCreateDayKey)) daysArr.push(initialCreateDayKey);
                            daysArr = [...new Set(daysArr)]; // Remove duplicates
                            daysArr.forEach(dateStr => {
                                if (!/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) return;
                                workouts[dateStr] = JSON.parse(JSON.stringify(workouts[currentWorkoutKey]));
                            });
                            localStorage.setItem('workouts', JSON.stringify(workouts));
                            hideWorkoutModal();
                            updateAll();
                            // Reset copy days input
                            createCopyDaysInput.value = '';
                            selectedCreatePopupDays = [];
                        }
                    };
                    cancelWorkoutBtn.onclick = hideWorkoutModal;

                    // Toggle between reps and time
                    isTimeInput.onchange = function() {
                        if (isTimeInput.checked) {
                            repsLabel.style.display = 'none';
                            timeLabel.style.display = '';
                        } else {
                            repsLabel.style.display = '';
                            timeLabel.style.display = 'none';
                        }
                    };

                    // Get key for a date
                    function getKey(year, month, day) {
                        return `${year}-${month + 1}-${day}`;
                    }

                    // Render calendar's info
                    function renderCalendar() {
                        daysContainer.innerHTML = '';
                        const year = date.getFullYear();
                        const month = date.getMonth();
                        monthYear.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });

                        let firstDay = new Date(year, month, 1).getDay();
                        // Adjust so Monday=0, Sunday=6
                        firstDay = (firstDay + 6) % 7;

                        const daysInMonth = new Date(year, month + 1, 0).getDate();

                        // Create day names
                        for (let i = 0; i < firstDay; i++) {
                            const li = document.createElement('li');
                            li.className = 'empty';
                            daysContainer.appendChild(li);
                        }

                        // Create day elements
                        for (let i = 1; i <= daysInMonth; i++) {
                            const li = document.createElement('li');
                            li.textContent = i;
                            const key = getKey(year, month, i);
                            if (workouts[key]) {
                                li.style.background = '#b3e6b3';
                                if (workouts[key].completed) {
                                    li.style.textDecoration = "line-through";
                                    li.style.opacity = "0.6";
                                }
                                li.title = workouts[key].title + "\n" + workouts[key].exercises.map(e => `${e.exercise} - ${e.sets}x${e.isTime ? `${e.time} sec` : `${e.reps} reps`} - ${e.weight} lb - ${e.rest} sec rest`).join('\n');
                            }
                            li.onclick = () => {
                                if (workouts[key]) {
                                    showViewWorkoutModal(key);
                                } else {
                                    alert('No workout for this day.');
                                }
                            };
                            daysContainer.appendChild(li);
                        }
                    }

                    // Render sidebar with years and workouts
                    function renderSidebar() {
                        const yearSelect = document.getElementById('sidebarYearSelect');
                        const yearContent = document.getElementById('sidebarYearContent');
                        yearSelect.innerHTML = '';
                        yearContent.innerHTML = '';

                        // Gather all years with workouts
                        const allWorkoutEntries = Object.entries(workouts)
                            .map(([key, workout]) => {
                                const [year, month, day] = key.split('-').map(Number);
                                const dateObj = new Date(year, month - 1, day);
                                return { key, workout, year, month, day, dateObj };
                            })
                            .sort((a, b) => a.dateObj - b.dateObj);

                        if (allWorkoutEntries.length === 0) {
                            yearContent.innerHTML = '<em>No workouts saved.</em>';
                            return;
                        }

                        // Get unique years
                        const years = [...new Set(allWorkoutEntries.map(e => e.year))].sort((a, b) => b - a);

                        // Populate year dropdown
                        years.forEach(y => {
                            const opt = document.createElement('option');
                            opt.value = y;
                            opt.textContent = y;
                            yearSelect.appendChild(opt);
                        });

                        // Show workouts for selected year
                        function showYear(selectedYear) {
                            yearContent.innerHTML = '';
                            // Group by month
                            const months = {};
                            allWorkoutEntries.forEach(e => {
                                if (e.year == selectedYear) {
                                    if (!months[e.month]) months[e.month] = [];
                                    months[e.month].push(e);
                                }
                            });

                            // Render months
                            Object.keys(months).sort((a, b) => a - b).forEach(monthNum => {
                                const monthArr = months[monthNum];
                                const monthName = new Date(selectedYear, monthNum - 1, 1).toLocaleString('default', { month: 'long' });
                                const monthDiv = document.createElement('div');
                                monthDiv.style.marginBottom = '10px';
                                monthDiv.innerHTML = `<strong>${monthName} (${monthArr.length} workout${monthArr.length > 1 ? 's' : ''})</strong>`;
                                const ul = document.createElement('ul');
                                ul.style.marginLeft = '10px';
                                monthArr.forEach(({ day, key, workout }) => {
                                    const li = document.createElement('li');
                                    li.style.cursor = 'pointer';
                                    li.textContent = `Day ${day}: ${workout.title}`;
                                    if (workout.completed) {
                                        li.style.textDecoration = "line-through";
                                        li.style.opacity = "0.6";
                                    }
                                    li.onclick = () => showViewWorkoutModal(key);
                                    ul.appendChild(li);
                                });
                                monthDiv.appendChild(ul);
                                yearContent.appendChild(monthDiv);
                            });
                        }

                        // Initial render
                        showYear(yearSelect.value = years[0]);

                        yearSelect.onchange = () => showYear(yearSelect.value);
                    }
                    
                    //Renders the workout accordion
                    function renderAccordion() {
                        // Save open IDs before clearing
                        const prevOpenIds = Array.from(document.querySelectorAll('#workoutAccordion .accordion-toggle.active'))
                            .map(btn => btn.getAttribute('data-acc-id'));

                        const container = document.getElementById('workoutAccordion');
                        container.innerHTML = '';

                        const year = date.getFullYear();
                        const month = date.getMonth();
                        const daysInMonth = new Date(year, month + 1, 0).getDate();

                        // Month section
                        const monthSection = document.createElement('div');
                        monthSection.className = 'accordion-section';
                        const monthHeader = document.createElement('button');
                        monthHeader.className = 'accordion-toggle';
                        monthHeader.setAttribute('data-acc-id', 'month');
                        monthHeader.innerHTML = date.toLocaleString('default', { month: 'long', year: 'numeric' }) + ' <span class="arrow" style="float:right;">▼</span>';
                        monthSection.appendChild(monthHeader);

                        const monthContent = document.createElement('div');
                        monthContent.className = 'accordion-content';

                        // Split days into weeks
                        let week = [];
                        let firstDay = new Date(year, month, 1).getDay();
                        firstDay = (firstDay + 6) % 7; // Monday=0
                        for (let i = 0; i < firstDay; i++) week.push(null);

                        for (let day = 1; day <= daysInMonth; day++) {
                            week.push(day);
                            if (week.length === 7 || day === daysInMonth) {

                                // Initialize week section
                                const weekSection = document.createElement('div');
                                weekSection.className = 'accordion-subsection';
                                const weekNum = Math.ceil((day + firstDay) / 7);
                                const weekHeader = document.createElement('button');
                                weekHeader.className = 'accordion-toggle';
                                weekHeader.setAttribute('data-acc-id', 'week-' + weekNum);
                                weekHeader.textContent = `Week ${weekNum}`;
                                weekSection.appendChild(weekHeader);

                                const weekContent = document.createElement('div');
                                weekContent.className = 'accordion-content';

                                // Create day elements
                                week.forEach((d, idx) => {
                                    if (d) {
                                        const key = getKey(year, month, d);
                                        const dayDiv = document.createElement('div');
                                        dayDiv.className = 'accordion-day';
                                        dayDiv.innerHTML = `<strong>${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][idx]} ${d}:</strong> `;
                                        if (workouts[key]) {
                                            let workoutTitleHtml = `<span class="workout-title" data-key="${key}" style="cursor:pointer;color:#2a5ad7;text-decoration:underline;${workouts[key].completed ? 'text-decoration:line-through;opacity:0.6;' : ''}">${workouts[key].title}</span>`;
                                            dayDiv.innerHTML += workoutTitleHtml + ' <button data-key="' + key + '" class="rest-toggle">Set Rest Day</button>';
                                        } else {
                                            dayDiv.innerHTML += 'Rest Day <button data-key="' + key + '" class="workout-toggle">Set Workout</button>';
                                        }
                                        weekContent.appendChild(dayDiv);
                                    }
                                });

                                // Append week content to week section
                                weekSection.appendChild(weekContent);
                                monthContent.appendChild(weekSection);
                                week = [];
                            }
                        }

                        monthSection.appendChild(monthContent);
                        container.appendChild(monthSection);

                        // Accordion toggle logic with arrow
                        container.querySelectorAll('.accordion-toggle').forEach(btn => {
                            btn.onclick = function() {
                                this.classList.toggle('active');
                                const content = this.nextElementSibling;
                                if (content) content.style.display = content.style.display === 'block' ? 'none' : 'block';
                                const arrow = this.querySelector('.arrow');
                                if (arrow) arrow.textContent = this.classList.contains('active') ? '▲' : '▼';
                            };
                            if (!btn.querySelector('.arrow')) {
                                const arrow = document.createElement('span');
                                arrow.className = 'arrow';
                                arrow.style.float = 'right';
                                arrow.textContent = btn.classList.contains('active') ? '▲' : '▼';
                                btn.appendChild(arrow);
                            }
                        });

                        // Restore open state by matching data-acc-id
                        container.querySelectorAll('.accordion-toggle').forEach(btn => {
                            if (prevOpenIds.includes(btn.getAttribute('data-acc-id'))) {
                                btn.classList.add('active');
                                const content = btn.nextElementSibling;
                                if (content) content.style.display = 'block';
                                const arrow = btn.querySelector('.arrow');
                                if (arrow) arrow.textContent = '▲';
                            }
                        });

                        // Workout/rest day logic
                        container.querySelectorAll('.rest-toggle').forEach(btn => {
                            btn.onclick = function() {
                                const key = this.getAttribute('data-key');
                                delete workouts[key];
                                localStorage.setItem('workouts', JSON.stringify(workouts));
                                updateAll();
                            };
                        });
                        
                        // Workout button logic
                        container.querySelectorAll('.workout-toggle').forEach(btn => {
                            btn.onclick = function() {
                                const key = this.getAttribute('data-key');
                                showWorkoutModal(key);
                            };
                        });

                        // Workout title click logic
                        container.querySelectorAll('.workout-title').forEach(span => {
                            span.onclick = function() {
                                const key = this.getAttribute('data-key');
                                showViewWorkoutModal(key);
                            };
                        });
                    }

                    // Helper to create an input
                    function createInput(type, value, min = null, style = "") {
                        const input = document.createElement('input');
                        input.type = type;
                        input.value = value;
                        if (min !== null) input.min = min;
                        if (style) input.style = style;
                        return input;
                    }

                    // Show workout modal with editable exercises
                    function showViewWorkoutModal(key) {
                        const workout = workouts[key];
                        if (!workout) return;
                        viewWorkoutKey = key;
                        viewWorkoutTitle.textContent = workout.title;
                        viewWorkoutExercises.innerHTML = '';

                        workout.exercises.forEach((ex, idx) => {
                            const li = document.createElement('li');
                            li.style.marginBottom = "6px";

                            // Display text
                            let desc = `${ex.exercise} - ${ex.sets} sets x `;
                            desc += ex.isTime ? `${ex.time} sec` : `${ex.reps} reps`;
                            desc += ex.weight && ex.weight > 0 ? ` @ ${ex.weight}${ex.weightUnit || 'lb'}` : '';
                            if (ex.rest && ex.rest > 0) desc += `, Rest: ${ex.rest}s`;

                            const descSpan = document.createElement('span');
                            descSpan.textContent = desc;

                            // Edit button
                            const editBtn = document.createElement('button');
                            editBtn.textContent = "Edit";
                            editBtn.style.marginLeft = "10px";
                            editBtn.style.fontSize = "12px";

                            editBtn.onclick = function() {
                                li.innerHTML = ""; // Clear li

                                // Exercise select dropdown
                                const exerciseSelect = document.createElement('select');
                                exerciseDatabase.forEach(e => {
                                    const opt = document.createElement('option');
                                    opt.value = e.name;
                                    opt.textContent = e.name;
                                    if (e.name === ex.exercise) opt.selected = true;
                                    exerciseSelect.appendChild(opt);
                                });
                                li.appendChild(exerciseSelect);

                                // Sets
                                const setsInput = createInput('number', ex.sets, 1, "width:40px;margin-left:4px;");
                                li.appendChild(document.createTextNode(" Sets: "));
                                li.appendChild(setsInput);

                                // Reps or Time
                                let isTime = ex.isTime;
                                let repsOrTimeInput;
                                let repsOrTimeLabel;
                                if (isTime) {
                                    repsOrTimeInput = createInput('number', ex.time, 1, "width:50px;margin-left:4px;");
                                    repsOrTimeLabel = document.createTextNode(" Time (sec): ");
                                } else {
                                    repsOrTimeInput = createInput('number', ex.reps, 1, "width:50px;margin-left:4px;");
                                    repsOrTimeLabel = document.createTextNode(" Reps: ");
                                }
                                li.appendChild(repsOrTimeLabel);
                                li.appendChild(repsOrTimeInput);

                                // Toggle between reps/time
                                const isTimeCheckbox = document.createElement('input');
                                isTimeCheckbox.type = 'checkbox';
                                isTimeCheckbox.checked = isTime;
                                isTimeCheckbox.style.marginLeft = "8px";
                                li.appendChild(isTimeCheckbox);
                                li.appendChild(document.createTextNode(" [Use Time]"));

                                isTimeCheckbox.onchange = function() {
                                    isTime = isTimeCheckbox.checked;
                                    // Remove and re-add the correct input/label
                                    li.removeChild(repsOrTimeInput);
                                    li.removeChild(repsOrTimeLabel);
                                    if (isTime) {
                                        repsOrTimeInput = createInput('number', ex.time || 30, 1, "width:50px;margin-left:4px;");
                                        repsOrTimeLabel = document.createTextNode(" Time (sec): ");
                                    } else {
                                        repsOrTimeInput = createInput('number', ex.reps || 10, 1, "width:50px;margin-left:4px;");
                                        repsOrTimeLabel = document.createTextNode(" Reps: ");
                                    }
                                    li.insertBefore(repsOrTimeLabel, isTimeCheckbox);
                                    li.insertBefore(repsOrTimeInput, isTimeCheckbox);
                                };

                                // Weight
                                const weightInput = createInput('number', ex.weight, 0, "width:50px;margin-left:4px;");
                                li.appendChild(document.createTextNode(" Weight: "));
                                li.appendChild(weightInput);

                                // Weight unit
                                const unitSelect = document.createElement('select');
                                ["lb", "kg"].forEach(u => {
                                    const opt = document.createElement('option');
                                    opt.value = u;
                                    opt.textContent = u;
                                    if ((ex.weightUnit || 'lb') === u) opt.selected = true;
                                    unitSelect.appendChild(opt);
                                });
                                li.appendChild(unitSelect);

                                // Rest
                                const restInput = createInput('number', ex.rest, 0, "width:50px;margin-left:4px;");
                                li.appendChild(document.createTextNode(" Rest (sec): "));
                                li.appendChild(restInput);

                                // Save/Cancel buttons
                                const saveBtn = document.createElement('button');
                                saveBtn.textContent = "Save";
                                saveBtn.style.marginLeft = "8px";
                                saveBtn.onclick = function() {
                                    // Validate and update
                                    const sets = parseInt(setsInput.value);
                                    const repsOrTime = parseInt(repsOrTimeInput.value);
                                    const weight = parseFloat(weightInput.value);
                                    const rest = parseInt(restInput.value);
                                    if (sets < 1 || (isTime ? repsOrTime < 1 : repsOrTime < 1)) {
                                        alert("Invalid input.");
                                        return;
                                    }
                                    workout.exercises[idx] = {
                                        ...ex,
                                        exercise: exerciseSelect.value,
                                        sets,
                                        reps: isTime ? null : repsOrTime,
                                        time: isTime ? repsOrTime : null,
                                        weight,
                                        rest,
                                        isTime,
                                        weightUnit: unitSelect.value
                                    };
                                    localStorage.setItem('workouts', JSON.stringify(workouts));
                                    showViewWorkoutModal(key);
                                };
                                li.appendChild(saveBtn);

                                const cancelBtn = document.createElement('button');
                                cancelBtn.textContent = "Cancel";
                                cancelBtn.style.marginLeft = "4px";
                                cancelBtn.onclick = function() {
                                    showViewWorkoutModal(key);
                                };
                                li.appendChild(cancelBtn);
                            };

                            li.appendChild(descSpan);
                            li.appendChild(editBtn);
                            viewWorkoutExercises.appendChild(li);
                        });

                        // Complete/Incomplete button
                        let completeBtn = document.getElementById('completeWorkoutBtn');
                        if (!completeBtn) {
                            completeBtn = document.createElement('button');
                            completeBtn.id = 'completeWorkoutBtn';
                            closeViewWorkoutBtn.parentNode.insertBefore(completeBtn, closeViewWorkoutBtn);
                        }
                        completeBtn.textContent = workout.completed ? "Incomplete" : "Complete";
                        completeBtn.style.marginRight = "10px";
                        completeBtn.disabled = false;
                        completeBtn.onclick = function() {
                            workout.completed = !workout.completed;
                            localStorage.setItem('workouts', JSON.stringify(workouts));
                            showViewWorkoutModal(key);
                            updateAll();
                        };

                        viewWorkoutModal.style.display = 'flex';
                    }

                    // Close workout modal
                    closeViewWorkoutBtn.onclick = () => {
                        viewWorkoutModal.style.display = 'none';
                    };

                    // Delete workout button
                    deleteWorkoutBtn.onclick = () => {
                        if (viewWorkoutKey && workouts[viewWorkoutKey]) {
                            if (confirm('Are you sure you want to delete this workout?')) {
                                delete workouts[viewWorkoutKey];
                                localStorage.setItem('workouts', JSON.stringify(workouts));
                                viewWorkoutModal.style.display = 'none';
                                updateAll();
                            }
                        }
                    };

                    // Copy workout to other days
                    copyToDaysBtn.onclick = () => {
                        if (!viewWorkoutKey || !workouts[viewWorkoutKey]) return;
                        const daysStr = copyDaysInput.value.trim();
                        if (!daysStr) {
                            alert("Enter one or more dates separated by commas.");
                            return;
                        }
                        const daysArr = daysStr.split(',').map(s => s.trim()).filter(Boolean);
                        let copied = 0;
                        daysArr.forEach(dateStr => {
                            if (!/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) return;
                            workouts[dateStr] = JSON.parse(JSON.stringify(workouts[viewWorkoutKey]));
                            copied++;
                        });
                        localStorage.setItem('workouts', JSON.stringify(workouts));
                        alert(`Workout copied to ${copied} day(s)!`);
                        updateAll();
                    };

                    selectDaysBtn.onclick = function() {
                        daysPopup.style.display = 'block';
                        // Center the popup
                        daysPopup.style.position = 'fixed';
                        daysPopup.style.top = '50%';
                        daysPopup.style.left = '50%';
                        daysPopup.style.transform = 'translate(-50%, -50%)';
                        renderPopupCalendar();
                    };

                    // Cancel button for the popup
                    cancelDaysBtn.onclick = function() {
                        daysPopup.style.display = 'none';
                    };

                    // Confirm selected days to copy
                    confirmDaysBtn.onclick = function() {
                        copyDaysInput.value = selectedPopupDays.join(',');
                        daysPopup.style.display = 'none';
                    };

                    function renderPopupCalendar() {
                        // Show current month
                        const now = new Date();
                        const year = now.getFullYear();
                        const month = now.getMonth();
                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                        let html = `<div style="text-align:center;font-weight:bold;margin-bottom:5px;">${now.toLocaleString('default', { month: 'long', year: 'numeric' })}</div>`;
                        html += '<div style="display:grid;grid-template-columns:repeat(7,30px);gap:2px;">';
                        ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d => html += `<span style="font-size:12px;">${d}</span>`);
                        let firstDay = new Date(year, month, 1).getDay();
                        firstDay = (firstDay + 6) % 7; // Monday=0
                        for (let i = 0; i < firstDay; i++) html += `<span></span>`;
                        for (let d = 1; d <= daysInMonth; d++) {
                            const key = `${year}-${month+1}-${d}`;
                            const selected = selectedPopupDays.includes(key);
                            html += `<button data-key="${key}" style="width:28px;height:28px;${selected ? 'background:#2a5ad7;color:#fff;' : ''}">${d}</button>`;
                        }
                        html += '</div>';
                        popupCalendar.innerHTML = html;
                        popupCalendar.querySelectorAll('button[data-key]').forEach(btn => {
                            btn.onclick = function() {
                                const key = this.getAttribute('data-key');
                                if (selectedPopupDays.includes(key)) {
                                    selectedPopupDays = selectedPopupDays.filter(k => k !== key);
                                } else {
                                    selectedPopupDays.push(key);
                                }
                                renderPopupCalendar();
                            };
                        });
                    }

                    // --- Copy to Days for Creation Modal ---
const createCopyDaysInput = document.getElementById('createCopyDaysInput');
const createSelectDaysBtn = document.getElementById('createSelectDaysBtn');
const createDaysPopup = document.getElementById('createDaysPopup');
const createPopupCalendar = document.getElementById('createPopupCalendar');
const createConfirmDaysBtn = document.getElementById('createConfirmDaysBtn');
const createCancelDaysBtn = document.getElementById('createCancelDaysBtn');
let selectedCreatePopupDays = [];

// State for the popup calendar
let createPopupMonth = null;
let createPopupYear = null;

createCancelDaysBtn.onclick = function() {
    createDaysPopup.style.display = 'none';
};

createSelectDaysBtn.onclick = function() {
    // Start at the month/year of the initial day
    if (initialCreateDayKey) {
        const [y, m] = initialCreateDayKey.split('-').map(Number);
        createPopupYear = y;
        createPopupMonth = m - 1;
    } else {
        const now = new Date();
        createPopupYear = now.getFullYear();
        createPopupMonth = now.getMonth();
    }
    createDaysPopup.style.display = 'block';
    createDaysPopup.style.position = 'fixed';
    createDaysPopup.style.top = '50%';
    createDaysPopup.style.left = '50%';
    createDaysPopup.style.transform = 'translate(-50%, -50%)';
    renderCreatePopupCalendar();
};

document.getElementById('createPrevMonthBtn').onclick = function() {
    createPopupMonth--;
    if (createPopupMonth < 0) {
        createPopupMonth = 11;
        createPopupYear--;
    }
    renderCreatePopupCalendar();
};
document.getElementById('createNextMonthBtn').onclick = function() {
    createPopupMonth++;
    if (createPopupMonth > 11) {
        createPopupMonth = 0;
        createPopupYear++;
    }
    renderCreatePopupCalendar();
};

function renderCreatePopupCalendar() {
    const year = createPopupYear;
    const month = createPopupMonth;
    document.getElementById('createPopupMonthYear').textContent =
        new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    let html = '<div style="display:grid;grid-template-columns:repeat(7,30px);gap:2px;">';
    ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d => html += `<span style="font-size:12px;">${d}</span>`);
    let firstDay = new Date(year, month, 1).getDay();
    firstDay = (firstDay + 6) % 7; // Monday=0
    for (let i = 0; i < firstDay; i++) html += `<span></span>`;
    for (let d = 1; d <= daysInMonth; d++) {
        const key = `${year}-${month+1}-${d}`;
        const isInitial = key === initialCreateDayKey;
        const selected = selectedCreatePopupDays.includes(key) || isInitial;
        html += `<button data-key="${key}" style="width:28px;height:28px;${selected ? 'background:#2a5ad7;color:#fff;' : ''};${isInitial ? 'border:2px solid #222;' : ''}" ${isInitial ? 'disabled' : ''}>${d}</button>`;
    }
    html += '</div>';
    createPopupCalendar.innerHTML = html;
    createPopupCalendar.querySelectorAll('button[data-key]').forEach(btn => {
        const key = btn.getAttribute('data-key');
        if (key === initialCreateDayKey) return;
        btn.onclick = function() {
            if (selectedCreatePopupDays.includes(key)) {
                selectedCreatePopupDays = selectedCreatePopupDays.filter(k => k !== key);
            } else {
                selectedCreatePopupDays.push(key);
            }
            renderCreatePopupCalendar();
        };
    });
}

                    // Initializes the calendar, accordion, workout list, and exercise list
                    function updateAll() {
                        renderCalendar();
                        renderAccordion();
                        renderSidebar();
                        renderCustomExercisesList();
                    }

                    // Updates the calendar for button presses
                    prevMonth.onclick = () => {
                        date.setMonth(date.getMonth() - 1);
                        updateAll();
                    };
                    nextMonth.onclick = () => {
                        date.setMonth(date.getMonth() + 1);
                        updateAll();
                    };

                    // Goes back to the previous page (Index typically)
                    const goBack = () => {
                        window.history.back();
                    };

                    updateAll();
                    //goBackBtn.addEventListener('click', goBack);
                    
                    // Close exercise info modal
                    document.getElementById('closeExerciseInfoBtn').onclick = function() {
                        document.getElementById('exerciseInfoModal').style.display = 'none';
                    };

                    const saveSharedBtn = document.getElementById('saveSharedBtn');
                    const loadSharedBtn = document.getElementById('loadSharedBtn');

                    saveSharedBtn.onclick = function() {
                      const code = prompt('Enter a unique name or keyword to save your workouts:');
                      if (code) {
                        db.collection('sharedWorkouts').doc(code).get().then(doc => {
                          if (doc.exists) {
                              alert('This keyword is already taken. Please choose another one.');
                      } else {
                          db.collection('sharedWorkouts').doc(code).set({
                          workouts: workouts,
                          timestamp: new Date()
                      }).then(() => {
                           // Save a local copy for your list
                          localStorage.setItem('sharedWorkouts_' + code, JSON.stringify(workouts));
                          alert('Your workouts are saved! Share this code with your friends: ' + code);
                          showAllMySharedWorkouts();
                      }).catch(err => {
                    alert('Error saving workouts: ' + err.message);
                });
            }
        }).catch(err => {
            alert('Error checking keyword: ' + err.message);
        });
                        }
                    };

                    // Load shared workouts
                    loadSharedBtn.onclick = function() {
                        const code = document.getElementById('shareCodeInput').value.trim();
                        if (code) {
                            db.collection('sharedWorkouts').doc(code).get().then(doc => {
                                if (doc.exists) {
                                    workouts = doc.data().workouts;
                                    localStorage.setItem('workouts', JSON.stringify(workouts));
                                    // Save a local copy for your shared list
                                    localStorage.setItem('sharedWorkouts_' + code, JSON.stringify(workouts));
                                    alert('Shared workouts loaded!');
                                    updateAll();
                                    showAllMySharedWorkouts();
                                } else {
                                    alert('No workouts found for this keyword.');
                                }
                            }).catch(err => {
                                alert('Error loading workouts: ' + err.message);
                            });
                        }
                    };

                    // Show all shared workouts
                    function showAllMySharedWorkouts() {
                        const list = document.getElementById('sharedWorkoutsList');
                        list.innerHTML = '';
                        // Find all sharedWorkouts_ keys in localStorage
                        Object.keys(localStorage).forEach(key => {
                            if (key.startsWith('sharedWorkouts_')) {
                                const code = key.replace('sharedWorkouts_', '');
                                const wrapper = document.createElement('div');
                                wrapper.style.display = "flex";
                                wrapper.style.alignItems = "center";
                                wrapper.style.marginBottom = "6px";

                                // Code button
                                const btn = document.createElement('button');
                                btn.textContent = code;
                                btn.style.margin = "4px";
                                btn.onclick = function() {
                                    const workoutsObj = JSON.parse(localStorage.getItem('sharedWorkouts_' + code));
                                    let msg = `Workouts for code "${code}":\n\n`;
                                    Object.entries(workoutsObj).forEach(([wkey, w]) => {
                                        // Parse date from key (format: YYYY-M-D)
                                        const [year, month, day] = wkey.split('-');
                                        msg += `${w.title || "Untitled"} - ${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}\n`;
                                    });
                                    msg += "\nCopy all to your calendar?";
                                    if (confirm(msg)) {
                                        Object.entries(workoutsObj).forEach(([wkey, workout]) => {
                                            workouts[wkey] = workout;
                                        });
                                        localStorage.setItem('workouts', JSON.stringify(workouts));
                                        alert('All workouts from this code copied to your calendar!');
                                        updateAll();
                                    }
                                };

                                // Delete button
                                const delBtn = document.createElement('button');
                                delBtn.textContent = "Delete";
                                delBtn.style.background = "#d9534f";
                                delBtn.style.color = "#fff";
                                delBtn.style.border = "none";
                                delBtn.style.marginLeft = "8px";
                                delBtn.style.padding = "4px 10px";
                                delBtn.style.borderRadius = "4px";
                                delBtn.onclick = function() {
                                    if (confirm(`Delete all workouts saved under code "${code}"?`)) {
                                        localStorage.removeItem('sharedWorkouts_' + code);
                                        showAllMySharedWorkouts();
                                    }
                                };

                                wrapper.appendChild(btn);
                                wrapper.appendChild(delBtn);
                                list.appendChild(wrapper);
                            }
                        });
                    }
                    
                    showAllMySharedWorkouts();
                    document.getElementById('print-button').onclick = function() {
                    window.open('printable-workouts.html', '_blank');
                    };

                    // === Sidebar toggle logic for mobile ===
                  document.getElementById('sidebarToggle').onclick = function(e) {
                  e.stopPropagation();
                  // Close the custom sidebar if open
                  document.getElementById('customExercisesSidebar').style.display = 'none';
                  const el = document.getElementById('workoutSidebar');
                  el.style.display = (el.style.display === 'block' ? 'none' : 'block');
                };
                  document.getElementById('customSidebarToggle').onclick = function(e) {
                  e.stopPropagation();
                  // Close the workout sidebar if open
                  document.getElementById('workoutSidebar').style.display = 'none';
                  const el = document.getElementById('customExercisesSidebar');
                  el.style.display = (el.style.display === 'block' ? 'none' : 'block');
                };
                window.addEventListener('click', function(e) {
                    if (window.innerWidth <= 700) {
                        ['workoutSidebar', 'customExercisesSidebar'].forEach(id => {
                            const el = document.getElementById(id);
                            if (el && el.style.display === 'block' && !el.contains(e.target) && !e.target.matches('#sidebarToggle, #customSidebarToggle')) {
                                el.style.display = 'none';
                            }
                        });
                    }
                });

}); // <-- End of DOMContentLoaded
              // Add custom exercise button logic
              document.getElementById('addCustomExerciseBtn').onclick = function() {
                const newName = prompt('Enter new exercise name:');
              if (newName && !exerciseDatabase.some(e => e.name === newName)) {
                  const description = prompt('Enter a description for this exercise (optional):') || "";
                  const image = prompt('Enter an image URL for this exercise (optional):') || "";
                  const newExercise = { name: newName, description, image };
                  exerciseDatabase.push(newExercise);
                localStorage.setItem(
                        'customExercises',
                JSON.stringify(exerciseDatabase.filter(e => !["Push Up","Squat","Pull Up","Bench Press","Deadlift","Plank"].includes(e.name)))
              );
                populateExerciseSelect();
                renderCustomExercisesList();
              // Optionally, set the select value to the new exercise:
              const select = document.getElementById('exerciseSelect');
              if (select) select.value = newName;
            } else if (newName) {
                  alert('Exercise already exists!');
            }
          };
                
            </script>

    </body>
</html>